<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adding a Model • portalcasting</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Adding a Model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">portalcasting</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adding_a_model.html">Adding a Model</a>
    </li>
    <li>
      <a href="../articles/codebase.html">portalcasting Codebase</a>
    </li>
    <li>
      <a href="../articles/howto.html">Set Up and Use a Portal Predictions Directory</a>
    </li>
    <li>
      <a href="../articles/models.html">Current Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/weecology/portalcasting">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Adding a Model</h1>
                        <h4 class="author">Juniper L. Simonis and Glenda M. Yenni</h4>
            
            <h4 class="date">21 March, 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/weecology/portalcasting/blob/master/vignettes/adding_a_model.Rmd"><code>vignettes/adding_a_model.Rmd</code></a></small>
      <div class="hidden name"><code>adding_a_model.Rmd</code></div>

    </div>

    
    
<p>The portalcasting package provides the ability to add functions both to a local copy of the repository for testing as well as to contribute to the base set of models provided within the package (and thus executed in the main respository.</p>
<p>For the purposes here, consider that you are interested in adding a model named “newmod” to the forecasting suite.</p>
<div id="model-input" class="section level3">
<h3 class="hasAnchor">
<a href="#model-input" class="anchor"></a>Model input</h3>
<p>All of the information needed to make a new forecast can be found in the <code>data/</code> subdirectory, including rodent and weather data files as well as a <code>metadata.yaml</code> file that contains the metadata controls to make sure the models match each other.</p>
</div>
<div id="model-requirements" class="section level3">
<h3 class="hasAnchor">
<a href="#model-requirements" class="anchor"></a>Model requirements</h3>
<p>In order to realize “newmod”, you need to create an R script named <code>newmod.R</code> and located within the <code>models/</code> subdirectory.</p>
<p>Forecasts generated by each model are saved in the <code>tmp/</code> subdirectory before being combined into a single file, used to build ensemble forecasts, saved in the predictions directory, and (if integrated into the Portal Predictions repository) archived. To facilitate integration, your model must generate a table of forecasts with specific columns names, saved to a file in <code>tmp/</code> that ends in <code>newmodforecasts.csv</code>. It must also generate a table of AIC values, also with specific column names, saved to a file in <code>tmp/</code> named <code>newmodforecasts_model_aic.csv.</code></p>
<div id="columns-of-the--forecasts-csv-file-need-to-be" class="section level4">
<h4 class="hasAnchor">
<a href="#columns-of-the--forecasts-csv-file-need-to-be" class="anchor"></a>Columns of the <code>-forecasts.csv</code> file need to be:</h4>
<p><code>date</code>: date on which the model was run. In the format <code>'YYYY-MM-DD'</code>. (If hindcasting is done then the date will be a later date than <code>forecastyear</code> or <code>forecastmonth</code>.)</p>
<p><code>forecastmonth</code>: the month of a prediction.</p>
<p><code>forecastyear</code>: the year of a prediction.</p>
<p><code>newmoonnumber</code>: the new moon ID of a prediction (new moon 1 is the first sample on 1977-07-16).</p>
<p><code>currency</code>: the type of value being predicted. Valid values are: <code>"abundance"</code>, <code>"richness"</code>, <code>"biomass"</code>, and <code>"energy"</code>, although only <code>"abundance"</code> is currently implemented.</p>
<p><code>model</code>: the name of the model.</p>
<p><code>level</code>: the spatial level of the site being predicted. Valid values are: <code>"All"</code>, <code>"Controls"</code>, <code>"FullExclosure"</code>, <code>"KratExclosure"</code>, and <code>"Plot1"</code>, <code>"Plot2"</code>, through to <code>"Plot24"</code>, although only <code>"All"</code> and <code>"Controls"</code> are currently implemented.</p>
<p><code>species</code>: the species being predicted. Valid values are all the rodent species codes (“AH”, “BA”, “PB”, “PH”, “PI”, “PP”, “PX”, “DM”, “DO”, “DX”, “DS”, “NA”, “OL”, “OX”, “OT”, “PF”, “PE”, “PL”, “PM”, “RF”, “RM”, “RO”, “RX”, “UR”, “SF”, “SH”, “SO”, “SX”, “SS”, “ST”, “SA”, “CS”, “CV”, “EO”, “SC”, “SU”, “UL”, “AS”, “AB”, “CM”, “CQ”, “CB”, “PC”, “PU”, “UP”, “PG”, “US”, “SB”, “ZL”) or “total” for the combined prediction of all species.</p>
<p><code>estimate</code>: the mean value of the prediction.</p>
<p><code>LowerPI</code>: the lower bound of the predicted 90% CI.</p>
<p><code>UpperPI</code>: the upper bound of the predicted 90% CI.</p>
<p><code>fit_start_newmoon</code>: the first newmoonnumber in the data used to make the prediction.</p>
<p><code>fit_end_newmoon</code>: the last newmoonnumber in the data used to make the prediction.</p>
<p><code>initial_newmoon</code>: the first newmoonnumber for which predictions are made in the set.</p>
<p><code>currency</code>, <code>level</code>, and <code>species</code> are the three unique things by which models will be compared with each other. That is, a model predicting <code>level</code>: <code>"all"</code>, <code>currency</code>: <code>"abundance"</code>, <code>species</code>: <code>"AH"</code> will only be compared against models making those same predictions.</p>
</div>
<div id="columns-of-the--forecasts_model_aic-csv-file-need-to-be" class="section level4">
<h4 class="hasAnchor">
<a href="#columns-of-the--forecasts_model_aic-csv-file-need-to-be" class="anchor"></a>Columns of the <code>-forecasts_model_aic.csv</code> file need to be:</h4>
<p><code>date</code>, <code>currency</code>, <code>model</code>, <code>level</code>, <code>species</code>, <code>fit_start_newmoon</code>, <code>fit_end_newmoon</code>, and <code>initial_newmoon</code> as in the <code>-forecasts.csv</code> file.</p>
<p><code>aic</code>: <a href="https://en.wikipedia.org/wiki/Akaike_information_criterion">Akaike Information Criterion</a> value.</p>
</div>
</div>
<div id="adding-models-locally" class="section level3">
<h3 class="hasAnchor">
<a href="#adding-models-locally" class="anchor"></a>Adding models locally</h3>
<p>Firstly, set up a base local version of the Portal Predictions repository via <code><a href="../reference/setup_dir.html">setup_dir()</a></code>.</p>
<p>Then, add your model script <code>newmod.R</code> to the <code>models/</code> subdirectory along with the existing base model set added by <code><a href="../reference/setup_dir.html">setup_dir()</a></code>.</p>
<p>You can then execute the new model within the forecasting (or hindcasting) pipeline as defined via <code><a href="../reference/portalcast.html">portalcast()</a></code>. To run only “newmod”, use</p>
<pre><code><a href="../reference/portalcast.html">portalcast(all_options(model = "newmod"))</a></code></pre>
<p>or, to run “newmod” in addition to the existing set of models, use</p>
<pre><code><a href="../reference/portalcast.html">portalcast(all_options(model = models(add = "newmod")))</a></code></pre>
</div>
<div id="contributing-models-to-the-base-set" class="section level3">
<h3 class="hasAnchor">
<a href="#contributing-models-to-the-base-set" class="anchor"></a>Contributing models to the base set</h3>
<p>The prefabricated (base) set of models available for use within the Portal Predictions pipeline is controlled through a few functions that will need to be ammended to add a new model. In addition to the model requirements outlined above, inclusion in the base set via portalcasting requires additional coding specifications be met to ensure proper use by the package and pipeline.</p>
<p><code><a href="../reference/fill_dir.html">fill_models()</a></code> fills the <code>models/</code> subdirectory with the R scripts used to drive the model running via calls to <code><a href="../reference/write_model.html">write_model()</a></code> for each of the desired models. <code><a href="../reference/fill_dir.html">fill_models()</a></code> is controlled by the options list generated by <code><a href="../reference/all_options.html">models_options()</a></code>, which includes an element named <code>model</code> that needs to list the name of every model within the base set, and which (by default) is generated by the <code><a href="../reference/model_names.html">model_names()</a></code> function. So, to update the default options lists, simply <strong>add the name of the model to the vector of model names returned by <code><a href="../reference/model_names.html">model_names(set = "prefab")</a></code></strong>.</p>
<p>Further, if your model requires covariates and uses a lag larger than 0 but shorter than the current minimum non-0 lag (6 moons), you should <strong>update the <code>min_lag</code> argument default in <code><a href="../reference/all_options.html">all_options()</a></code>, <code><a href="../reference/all_options.html">data_options()</a></code>, and <code><a href="../reference/all_options.html">covariates_options()</a></code></strong>.</p>
<p><code><a href="../reference/fill_dir.html">fill_models()</a></code> executes a series of functions (one for each model) that are named as <code>&lt;modelname&gt;_options</code> (<em>e.g.</em>, <code><a href="../reference/model_options.html">AutoArima_options()</a></code>), which define the specific options (<code>options_model</code> argument, generally created by <code><a href="../reference/model_options.html">model_options()</a></code>) required for the given model within the <code><a href="../reference/write_model.html">write_model()</a></code> function. Thus, to ensure the model script can be written, you will need to <strong>create a function called <code>newmod_options</code></strong>, which functionally sets the inputs to <code><a href="../reference/model_options.html">model_options()</a></code> for the specific model, and <strong>include newmod_options<code>in the</code>model_options.R<code>script within the</code>R/<code>subdirectory of the portalcasting package folder** (likely a local  clone of the repository). Following covention for existing models, **add  the documentation for</code>newmod_options<code>to the general</code>model_options()` documentation using the <span class="citation">@rdname</span> tag.</strong></p>
<p>For each model, <code><a href="../reference/write_model.html">write_model()</a></code> makes a call to the <code><a href="../reference/write_model.html">model_template()</a></code> function, which creates the associated text of the associated R script based on the input options. For “newmod” to integrate into the pipeline, you need to <strong>write a function with the same name as your model</strong> (<code>newmod</code> here). Given current implementation, the simplest usage is to have the model function with three arguments: [1]: <code>tree</code>, a directory tree object created by <code><a href="../reference/dirtree.html">dirtree()</a></code>; [2] <code>level</code>, which should be able to toggle between <code>"all"</code> and <code>"controls"</code>; and [3] <code>quiet</code> a logical value to notify internal functions whether or not to output messages about model running. For reference, see <code><a href="../reference/autoarima.html">AutoArima()</a></code>.</p>
<p>To facilitate error catching and checking, there is a generalized function named <code><a href="../reference/check_args.html">check_args()</a></code> that will automatically check the arguments inputted to a function to ensure validity. It is <strong><em>highly recommended</em></strong> that you include a call to <code><a href="../reference/check_args.html">check_args()</a></code> as the first line of <code>newmod()</code>. After that, please add entries for <code>newmod</code> in the documentation of <code><a href="../reference/check_args.html">check_arg()</a></code> for all relevant arguments (<code>tree</code>, <code>level</code>, <code>quiet</code>, and perhaps <code>lag</code>) by including <code>\code{\link{newmod}},</code> in the (alphabetical) function lists for each argument. No edits are needed within the active code of <code><a href="../reference/check_args.html">check_args()</a></code> or <code><a href="../reference/check_args.html">check_arg()</a></code> unless new arguments are being added. If that is the case, new arguments <strong><em>must not</em></strong> clash with any existing argument names.</p>
<p>Output from your model function will be put into <code><a href="../reference/save_forecast_output.html">save_forecast_output()</a></code>, which combines output from the <code>"all"</code> and <code>"controls"</code> forecasts based on the assumption of a two-element list (<code>"forecast"</code> and <code>"aic"</code>) from each run of the function. Thus, to work within the pipeline specifically, <strong>your model function needs to return a list with two elements corresponding to the output requirements outline above</strong>. Once completed, <strong>the <code>newmod</code> function needs to be included within the <code>R/</code> directory of the portalcasting repository</strong>. Following convention, <strong>put the code for <code>newmod()</code> in a new script named newmod.R`</strong>. <strong>Document the function using roxygen headers</strong>.</p>
<p>Add tests for your model’s function to the <code>tests/testthat</code> folder. Following convention, **add your tests to a new script named <code>test-XX-newmod.R</code>, where <code>XX</code> is the number one fewer than the total number of scripts in the folder, as the <code>figures.R</code> test should remain last. You can leverage the the fact that the testing setup created a directory for test usage:</p>
<pre><code>tree &lt;- dirtree(main = "testing_casting")</code></pre>
<p>Note, however, that to facilitate speed of testing functions, the data set is trimmed to a single species. If specific edge cases need to be tested, consider writing isolated functions to catch those cases and then test them specifically as unit tests.</p>
<p>If your model function requires any external code, <strong>additional libraries need to be added to the DESCRIPTION file</strong>.</p>
<p>Having added the <code>newmod</code> and <code>newmod_options</code> functions to the package,<br>
updated the existing functions (<code><a href="../reference/model_names.html">model_names()</a></code> and, if necessary, <code><a href="../reference/all_options.html">all_options()</a></code>, <code><a href="../reference/all_options.html">data_options()</a></code>, and <code><a href="../reference/all_options.html">covariates_options()</a></code>), added entries in the documentation of <code>clean_arg()</code> if <code>clean_args()</code> is being used, and added dependencies, you should then <strong>update the documentation using <code><a href="https://www.rdocumentation.org/packages/devtools/topics/document">devtools::document()</a></code> and re-load the package using <code><a href="https://www.rdocumentation.org/packages/devtools/topics/load_all">devtools::load_all()</a></code></strong>. Then, use the updated package to <strong>verify that newmod is properly integrated into the pipeline under default settings by running <code><a href="../reference/setup_dir.html">setup_dir()</a></code> then <code><a href="../reference/portalcast.html">portalcast()</a></code></strong>, which should execute cleanly. You should <strong>then run <code><a href="../reference/cleanup_dir.html">cleanup_dir()</a></code> to remove the temporary files and folders from the repository</strong>.</p>
<p>Once the code has run successfully (including the integration of the output from “newmod” into the ensemble) and the respository has been cleaned up, <strong>create a Pull Request to the portalcasting repository</strong></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Juniper L. Simonis, Glenda M. Yenni, Ellen K. Bledsoe, Erica M. Christensen, Shawn D. Taylor, Hao Ye, Ethan P. White, S.K. Morgan Ernest.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
